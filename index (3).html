<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Layout Bus Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    .seat-grid {
      display: grid;
      gap: 5px;
      margin-bottom: 20px;
    }
    .cell {
      width: 50px;
      height: 50px;
      text-align: center;
      line-height: 50px;
      border: 1px solid #ccc;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }
    .asiento { background-color: #0d6efd; color: white; }
    .pasillo { background-color: #dee2e6; }
    .baño    { background-color: #198754; color: white; }
    .vacio   { background-color: #f8f9fa; color: #ccc; }
  </style>
</head>
<body class="p-4">
  <h2>Configurador de Layout de Bus</h2>

  <div id="setupForm">
    <h4>Configuración inicial</h4>
    <form id="configForm">
      <div class="row mb-3">
        <div class="col">
          <label class="form-label">Filas piso 1:</label>
          <input type="number" class="form-control" id="rows1" value="10" required>
        </div>
        <div class="col">
          <label class="form-label">Columnas piso 1:</label>
          <input type="number" class="form-control" id="cols1" value="4" required>
        </div>
      </div>
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="enableFloor2">
        <label class="form-check-label" for="enableFloor2">Agregar piso 2</label>
      </div>
      <div id="floor2Options" class="row mb-3 d-none">
        <div class="col">
          <label class="form-label">Filas piso 2:</label>
          <input type="number" class="form-control" id="rows2" value="5">
        </div>
        <div class="col">
          <label class="form-label">Columnas piso 2:</label>
          <input type="number" class="form-control" id="cols2" value="4">
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Crear Layout</button>
    </form>
  </div>

  <div id="editor" class="d-none">
    <div class="mb-3 mt-4">
      <label for="floorSelector" class="form-label">Piso:</label>
      <select id="floorSelector" class="form-select w-auto">
        <option value="floor1" selected>Piso 1</option>
        <option value="floor2">Piso 2</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="typeSelector" class="form-label">Tipo de celda:</label>
      <select id="typeSelector" class="form-select w-auto">
        <option value="asiento">Asiento</option>
        <option value="pasillo">Pasillo</option>
        <option value="baño">Baño</option>
        <option value="vacio">Vacío</option>
      </select>
    </div>

    <div id="floor1" class="seat-grid"></div>
    <div id="floor2" class="seat-grid d-none"></div>

    <p class="mt-2"><strong>Total de asientos:</strong> <span id="seatCount">0</span></p>

    <button id="saveBtn" class="btn btn-success mt-2">Guardar Layout</button>

    <h4 class="mt-4">Archivo layouts.json:</h4>
    <pre id="output" class="bg-light p-3 border rounded"></pre>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    let layoutData = {
      floor1: [],
      floor2: []
    };
    let allLayouts = {};

    const abc = ["A", "B", "C", "D", "E", "F", "G", "H"];

    function buildGrid(floorId, rows, cols) {
      const grid = $(`#${floorId}`);
      grid.empty().css("grid-template-columns", `repeat(${cols}, 50px)`);
      layoutData[floorId] = [];

      for (let r = 0; r < rows; r++) {
        layoutData[floorId][r] = [];
        for (let c = 0; c < cols; c++) {
          const label = `${r + 1}${abc[c] || ''}`;
          layoutData[floorId][r][c] = label;

          const cell = $(`<div class="cell asiento">${label}</div>`);
          cell.data({ row: r, col: c, type: 'asiento' });

          cell.on('click', function () {
            const type = $('#typeSelector').val();
            const $this = $(this);
            const row = $this.data('row');
            const col = $this.data('col');

            $this.removeClass().addClass(`cell ${type}`);
            $this.data('type', type);

            if (type === 'asiento') {
              layoutData[floorId][row][col] = '';
            } else if (type === 'baño') {
              $this.text('WC');
              layoutData[floorId][row][col] = 'WC';
            } else {
              $this.text('');
              layoutData[floorId][row][col] = '';
            }

            renumerarFila(floorId, row, cols);
            updateSeatCount();
          });

          grid.append(cell);
        }
      }

      updateSeatCount();
    }

    function renumerarFila(floorId, rowIdx, cols) {
      let seatCount = 0;
      for (let c = 0; c < cols; c++) {
        const index = rowIdx * cols + c;
        const cell = $(`#${floorId} .cell`).eq(index);
        if (cell.data('type') === 'asiento') {
          const newLabel = `${rowIdx + 1}${abc[seatCount] || ''}`;
          cell.text(newLabel);
          layoutData[floorId][rowIdx][c] = newLabel;
          seatCount++;
        }
      }
    }

    function updateSeatCount() {
      let count = 0;
      for (const floor in layoutData) {
        layoutData[floor].forEach(row => {
          row.forEach(seat => {
            if (typeof seat === 'string' && seat.match(/^\d+[A-Z]$/)) count++;
          });
        });
      }
      $('#seatCount').text(count);
    }

    $('#enableFloor2').on('change', function () {
      $('#floor2Options').toggleClass('d-none', !this.checked);
    });

    $('#configForm').on('submit', function (e) {
      e.preventDefault();

      const rows1 = parseInt($('#rows1').val());
      const cols1 = parseInt($('#cols1').val());
      const enable2 = $('#enableFloor2').is(':checked');
      const rows2 = parseInt($('#rows2').val());
      const cols2 = parseInt($('#cols2').val());

      buildGrid('floor1', rows1, cols1);
      if (enable2) {
        $('#floorSelector option[value="floor2"]').show();
        $('#floor2').removeClass('d-none');
        buildGrid('floor2', rows2, cols2);
      } else {
        $('#floorSelector option[value="floor2"]').hide();
        $('#floor2').addClass('d-none');
      }

      $('#setupForm').hide();
      $('#editor').removeClass('d-none');
    });

    $('#floorSelector').on('change', function () {
      const floor = $(this).val();
      $('#floor1, #floor2').addClass('d-none');
      $(`#${floor}`).removeClass('d-none');
    });

    $('#saveBtn').on('click', function () {
      const name = prompt('Ingrese un nombre para este layout:');
      if (!name) return alert('Debe ingresar un nombre válido.');

      const layout = {
        floor1: { seatMap: layoutData.floor1 }
      };

      if ($('#enableFloor2').is(':checked')) {
        layout.floor2 = { seatMap: layoutData.floor2 };
      }

      allLayouts[name] = layout;

      const output = {
        layouts: allLayouts
      };

      $('#output').text(JSON.stringify(output, null, 2));
    });
  </script>
</body>
</html>
